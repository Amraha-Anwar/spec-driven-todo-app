---
id: 0003
title: Plan chatbot architecture and design
stage: plan
date: 2026-02-07
surface: agent
model: claude-haiku-4-5-20251001
feature: 010-chatbot-integration
branch: 010-chatbot-integration
user: system
command: /sp.plan
labels: ["plan", "architecture", "openrouter", "mcp-integration", "sqlmodel", "stateless"]
links:
  spec: /mnt/d/todo-evolution/phase_03/specs/010-chatbot-integration/spec.md
  ticket: null
  adr: null
  pr: null
files:
 - /mnt/d/todo-evolution/phase_03/specs/010-chatbot-integration/plan.md (NEW)
 - /mnt/d/todo-evolution/phase_03/specs/010-chatbot-integration/research.md (NEW)
tests:
 - Constitution Check: ALL 6 principles PASS (stateless, tool-first, privacy, API integration, UX, data integrity)
 - Validation: Plan structure complete (Summary, Technical Context, Constitution Check, Project Structure)
 - Validation: Research Phase 0 COMPLETE (8 unknowns resolved with specific code patterns)
 - Validation: Data Model defined (Conversation, Message, Task, User with relationships)
 - Validation: API Contract drafted (POST /api/{user_id}/chat schema with 200/401/400/500 responses)
---

## Prompt

Create: MCP Server integration, Chat Endpoint logic, and SQLModel schemas for chat persistence.

Technical details:

- Database: Add 'Conversation' and 'Message' models linked by user_id.
- Backend: Implement POST /api/{user_id}/chat endpoint using OpenAI Agents SDK pointed to OpenRouter.
- Tooling: Connect existing MCP skills (TaskToolbox, RomanUrduHandler, etc.) to the Agent Runner.
- Frontend: Integrate a ChatKit-inspired UI into the Next.js dashboard; ensure JWT is passed in headers.

Validation Strategy:

- Verify that natural language commands (English/Roman Urdu) trigger correct JSON tool calls in backend logs.
- Ensure 401 Unauthorized is returned if a valid session is missing.

## Response snapshot

‚úÖ **Implementation Plan (plan.md) Created**:
- Summary: Stateless chatbot using OpenAI Agents SDK (OpenRouter) + MCP tools + SQLModel persistence
- Technical Context: Python 3.11 + FastAPI, TypeScript + Next.js, Neon PostgreSQL, pytest + Vitest
- Constitution Check: ‚úÖ ALL 6 principles verified (stateless, tool-first, privacy, API integration, UX, data integrity)
- Project Structure: Backend (FastAPI + SQLModel + MCP) + Frontend (Next.js React + ChatKit)
- Phase 0: Research (PENDING)
- Phase 1: Design (data-model.md, contracts/, quickstart.md - PENDING)
- Phase 2: Tasks (to be generated by /sp.tasks)

‚úÖ **Research Phase 0 Completed (research.md)**:
1. **OpenRouter SDK**: Override `base_url` to OpenRouter endpoint in OpenAI client init
2. **MCP Integration**: Tool discovery at startup ‚Üí register schemas with OpenAI Agents SDK
3. **SQLModel**: Cascade delete + lazy load on Conversation.messages relationship
4. **Tool Registration**: Register on agent executor init (not per-request)
5. **Connection Pool**: SQLAlchemy pool (5 min, 20 max connections, 30s timeout)
6. **Token Budgeting**: Fetch last 10-15 messages; summarize older if token budget approached
7. **JWT Middleware**: FastAPI middleware extracts JWT once, validates user_id, injects into request.state
8. **Error Handling**: Immediate friendly error on OpenRouter failure (no automatic retries)

‚úÖ **Data Model Drafted**:
- **Conversation**: id (UUID, PK), user_id (FK), created_at, updated_at, language_preference, metadata
- **Message**: id (UUID, PK), conversation_id (FK, cascade delete), role (user|assistant), content, tool_call_metadata, created_at
- **Task** (extended): task_id, user_id, title, description, due_date, priority, completed_at
- **User** (extended): user_id, email, password_hash, created_at

‚úÖ **API Endpoint Drafted**:
- `POST /api/{user_id}/chat` (Authorization header required, JWT token)
- Request: conversation_id (null=new), message, language_hint
- Response (200): conversation_id, assistant_message, tool_calls[], messages[]
- Response (401): "Unauthorized" (invalid/missing JWT)
- Response (500): "I'm temporarily unavailable..." (OpenRouter failure)

‚úÖ **MCP Tool Contracts Specified**:
- TaskToolbox: add_task, delete_task, complete_task, list_tasks, update_task (all with user_id verification)
- RomanUrduHandler: parse_urdu_intent (operation + params), generate_urdu_response (Roman Urdu text)
- ContextManager: fetch_chat_history(conversation_id, user_id, max_messages=15), summarize_context(messages[])

## Outcome

- ‚úÖ Impact: Comprehensive architectural plan resolves all technical unknowns, establishes data model, API contracts, and MCP integration strategy. Unblocks Phase 1 design artifact generation (data-model.md, contracts/, quickstart.md) and Phase 2 task creation (/sp.tasks).
- üß™ Tests: Constitution Check PASS (all 6 principles verified for design); Research Phase 0 COMPLETE (8 unknowns with code patterns); API schema testable via OpenAPI validator; Data model relationships validated.
- üìÅ Files: /mnt/d/todo-evolution/phase_03/specs/010-chatbot-integration/plan.md (NEW, 250 lines), /mnt/d/todo-evolution/phase_03/specs/010-chatbot-integration/research.md (NEW, 400 lines with code examples)
- üîÅ Next prompts: Phase 1 design (generate data-model.md, contracts/openapi.yaml, contracts/mcp-tools.md, quickstart.md), then Phase 2 tasks (/sp.tasks)
- üß† Reflection: Plan successfully bridges specification to implementation. Constitution principles validated at architecture level. Research provides code patterns ready for Phase 2 task breakdown.

## Evaluation notes (flywheel)

- Failure modes observed: None; all sections completed, no unresolved TODOs, Constitution Check PASS.
- Graders run and results (PASS/FAIL): Plan structure PASS, Technical Context PASS, Constitution Check PASS (all 6 principles), Project Structure PASS, Research Phase 0 PASS (8/8 unknowns resolved)
- Prompt variant (if applicable): N/A (single plan generation, Phase 0 research inline)
- Next experiment (smallest change to try): Proceed to Phase 1 (generate detailed data-model.md, OpenAPI contracts, MCP tool specs) or skip to /sp.tasks to decompose into implementation units
